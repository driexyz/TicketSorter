<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Sorter v4</title>
    <style>
        :root {
            --bg-color: #ffffff; --text-color: #333333; --card-bg: #f8f9fa;
            --border-color: #dddddd; --primary-btn: #007bff; --secondary-btn: #28a745;
        }
        [data-theme="dark"] {
            --bg-color: #121212; --text-color: #e0e0e0; --card-bg: #1e1e1e;
            --border-color: #444444; --primary-btn: #4d82ff; --secondary-btn: #218838;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: 0.3s; padding: 20px; max-width: 800px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        textarea { width: 100%; height: 180px; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); background-color: var(--card-bg); color: var(--text-color); box-sizing: border-box; font-family: monospace; }
        .btn-group { margin: 15px 0; display: flex; gap: 10px; }
        button { padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .primary { background-color: var(--primary-btn); color: white; }
        .success { background-color: var(--secondary-btn); color: white; margin-top: 10px; }
        .output-box { margin-top: 10px; padding: 15px; border-radius: 8px; background-color: var(--card-bg); border: 1px solid var(--border-color); white-space: pre-wrap; font-family: monospace; font-size: 14px; }
        .section-header { display: flex; justify-content: space-between; align-items: baseline; margin-top: 25px; }
        h4 { margin: 0; color: var(--primary-btn); }
        .count-badge { font-size: 0.8em; background: var(--border-color); padding: 2px 8px; border-radius: 10px; color: var(--text-color); }
        .error-msg { color: #dc3545; font-size: 0.9em; margin-top: 5px; display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Ticket Sorter v4</h2>
        <button onclick="toggleTheme()" id="themeBtn">ðŸŒ™ Dark Mode</button>
    </div>

    <p>Paste your Sheet data here (expects 5 columns):</p>
    <textarea id="inputData" placeholder="Ticket    Preclosed    Closing    Status	Note"></textarea>
    <div id="errorBox" class="error-msg">Some rows could not be processed. Ensure you copied all 5 columns.</div>
    
    <div class="btn-group">
        <button class="primary" onclick="processData()">Process Data</button>
        <button onclick="clearAll()">Clear</button>
    </div>

    <div id="resultsArea" style="display:none;">
        <hr>
        
        <div id="preclosedSection">
            <div class="section-header">
                <h4>Pending Preclosed:</h4>
                <span id="countPre" class="count-badge"></span>
            </div>
            <div id="outputPre" class="output-box"></div>
            <button class="success" onclick="copyText('outputPre')">Copy Preclosed List</button>
        </div>

        <div id="sudahSection" style="display:none;">
            <div class="section-header">
                <h4>Sudah / Done Closing:</h4>
                <span id="countSudah" class="count-badge"></span>
            </div>
            <div id="outputSudah" class="output-box"></div>
            <button class="success" onclick="copyText('outputSudah')">Copy Sudah List</button>
        </div>
    </div>

    <script>
        function toggleTheme() {
            const body = document.documentElement;
            const btn = document.getElementById('themeBtn');
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            btn.innerText = isDark ? "ðŸŒ™ Dark Mode" : "â˜€ï¸ Light Mode";
        }

        function processData() {
            const input = document.getElementById('inputData').value.trim();
            if (!input) return;

            let lines = input.split('\n');
            let preList = [];
            let sudahList = [];
            let errorFound = false;

            lines.forEach(line => {
                if (!line.trim()) return; // Skip totally empty lines

                // Split by TAB first (primary for Sheets)
                let parts = line.split('\t');
                
                // If tabs aren't found, try splitting by multiple spaces
                if (parts.length < 2) {
                    parts = line.split(/\s{2,}/);
                }

                // We need at least Ticket (0), Preclosed (1), and Closing (2)
                // Note is (4). If column 4 is missing, we treat it as empty.
                if (parts.length >= 3) {
                    const ticket = parts[0]?.trim() || "Unknown";
                    const preTime = parts[1]?.trim() || "";
                    const closeTime = parts[2]?.trim() || "";
                    const note = (parts[4] || "").trim().toLowerCase();

                    const item = { ticket, pre: preTime, close: closeTime };

                    if (note.includes('sudah') || preTime === '-') {
                        sudahList.push(item);
                    } else {
                        preList.push(item);
                    }
                } else {
                    errorFound = true;
                }
            });

            // Sort by preclosed time (handling '-' as a string)
            const timeSort = (a, b) => a.pre.localeCompare(b.pre);
            preList.sort(timeSort);
            sudahList.sort(timeSort);

            // Output Preclosed
            document.getElementById('outputPre').innerText = preList.map(i => 
                `${i.ticket} preclosed ${i.pre} closing ${i.close}`).join('\n');
            document.getElementById('countPre').innerText = preList.length + " tickets";

            // Output Sudah
            document.getElementById('outputSudah').innerText = sudahList.map(i => 
                `${i.ticket} closing ${i.close}`).join('\n');
            document.getElementById('countSudah').innerText = sudahList.length + " tickets";

            // UI logic
            document.getElementById('resultsArea').style.display = 'block';
            document.getElementById('sudahSection').style.display = sudahList.length > 0 ? 'block' : 'none';
            document.getElementById('preclosedSection').style.display = preList.length > 0 ? 'block' : 'none';
            document.getElementById('errorBox').style.display = errorFound ? 'block' : 'none';
        }

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text);
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "âœ“ Copied!";
            setTimeout(() => btn.innerText = originalText, 2000);
        }

        function clearAll() {
            document.getElementById('inputData').value = '';
            document.getElementById('resultsArea').style.display = 'none';
            document.getElementById('errorBox').style.display = 'none';
        }
    </script>
</body>
</html>
